<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>استيراد البيانات</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"  crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"  crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> 
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"  rel="stylesheet" />
</head>
<body class="min-h-screen bg-gray-50 p-4">
  <div id="root"></div>

  <script type="text/babel">
    const App = () => {
      const [file, setFile] = React.useState(null);
      const [message, setMessage] = React.useState('');

      const handleFileChange = (e) => {
        setFile(e.target.files[0]);
      };

      const parseMarkdown = (content) => {
        const promptRegex = /\d+\.\s*\*\*$$(.*?)$$\s*→\s*(.*?)\*\*.*?\n(.*?)(?=\n\d+\.|\Z)/gs;
        const prompts = [];
        let match;

        while ((match = promptRegex.exec(content)) !== null) {
          const fullMatch = match[0];
          const mainCategory = match[1].trim();
          const subCategory = match[2].trim();
          const text = match[3].replace(/^-.*$/gm, '').trim(); // تنظيف النص
          const idMatch = /`ID:\s*(\d+)`/.exec(fullMatch);
          const tokensMatch = /`tokens:\s*(\d+)`/.exec(fullMatch);

          if (text && idMatch && tokensMatch) {
            const id = parseInt(idMatch[1], 10);
            const tokens = parseInt(tokensMatch[1], 10);

            prompts.push({
              id,
              text,
              category: mainCategory,
              subCategory,
              tokens
            });
          }
        }

        return prompts;
      };

      const handleImport = () => {
        if (!file) {
          alert("الرجاء اختيار ملف Markdown.");
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target.result;
          const importedPrompts = parseMarkdown(content);

          if (importedPrompts.length === 0) {
            setMessage("❌ لم يتم العثور على برومبتات في الملف.");
            return;
          }

          // جلب البيانات الحالية من localStorage
          const existingPrompts = JSON.parse(localStorage.getItem('prompts')) || [];
          const existingCategories = JSON.parse(localStorage.getItem('categories')) || [];
          const existingSubCategories = JSON.parse(localStorage.getItem('subCategories')) || {};

          // تجنب التكرار باستخدام Set
          const existingIds = new Set(existingPrompts.map(p => p.id));
          const newPrompts = importedPrompts.filter(p => !existingIds.has(p.id));

          // تحديث القائمة مع الحفاظ على البيانات القديمة
          const updatedPrompts = [...existingPrompts, ...newPrompts];

          // تحديث الأقسام
          const updatedCategories = [...new Set([
            ...existingCategories,
            ...newPrompts.map(p => p.category)
          ])];

          // تحديث الأقسام الفرعية
          const updatedSubCategories = { ...existingSubCategories };
          newPrompts.forEach(prompt => {
            if (!updatedSubCategories[prompt.category]) {
              updatedSubCategories[prompt.category] = [];
            }
            if (
              prompt.subCategory &&
              !updatedSubCategories[prompt.category].includes(prompt.subCategory)
            ) {
              updatedSubCategories[prompt.category].push(prompt.subCategory);
            }
          });

          // حفظ البيانات بعد التحديث
          localStorage.setItem('prompts', JSON.stringify(updatedPrompts));
          localStorage.setItem('categories', JSON.stringify(updatedCategories));
          localStorage.setItem('subCategories', JSON.stringify(updatedSubCategories));

          setMessage(`✅ تم استيراد ${newPrompts.length} برومبت جديد.`);
          setTimeout(() => {
            window.location.href = "index.html";
          }, 2000);
        };

        reader.readAsText(file);
      };

      return (
        <div className="max-w-2xl mx-auto bg-white p-6 rounded shadow-md">
          <h2 className="text-2xl font-bold mb-4">استيراد البيانات</h2>
          <p className="mb-4">اختر ملف Markdown يحتوي على بيانات برومبتات لإضافتها إلى قاعدة البيانات الحالية.</p>
          
          <input
            type="file"
            accept=".md"
            onChange={handleFileChange}
            className="w-full p-2 border border-gray-300 rounded mb-4"
          />

          <button
            onClick={handleImport}
            className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition"
          >
            استيراد البيانات
          </button>

          {message && (
            <div className="mt-4 p-3 bg-blue-100 text-blue-700 rounded">
              {message}
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
