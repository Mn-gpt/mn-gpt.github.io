<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>استيراد البيانات</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"  crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"  crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> 
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"  rel="stylesheet" />
</head>
<body class="bg-gray-50 p-6 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const App = () => {
      const [message, setMessage] = React.useState('');
      const fileInputRef = React.useRef(null);

      // معالجة ملف Markdown
      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const content = event.target.result;
          const existingPrompts = JSON.parse(localStorage.getItem('prompts')) || [];

          // استخراج البرومبتات من النص
          const lines = content.split('\n');
          const newPrompts = [];

          let currentCategory = '';
          let currentSubCategory = '';

          lines.forEach(line => {
            line = line.trim();
            const promptMatch = line.match(/^(\d+\.|\-|\*)\s+\$\$(.*?)\$\$\s+(.+?)(?:\s*-\s*`ID:\s*(\d+)`)?(?:\s*-\s*`tokens:\s*(\d+)`)?$/);
            if (!promptMatch) return;

            const [, , categoryPart = '', text = '', idStr = '', tokensStr = ''] = promptMatch;
            let mainCat = 'عام';
            let subCat = '';

            if (categoryPart.includes('→')) {
              [mainCat, subCat] = categoryPart.split('→').map(s => s.trim());
            } else if (categoryPart.includes(':')) {
              [mainCat, subCat] = categoryPart.split(':').map(s => s.trim());
            } else {
              mainCat = categoryPart.trim() || 'عام';
            }

            const id = parseInt(idStr) || Date.now() + Math.floor(Math.random() * 1000);
            const tokens = parseInt(tokensStr) || Math.ceil(text.split(/\s+/).length * 1.25);

            newPrompts.push({
              id,
              text,
              category: mainCat,
              subCategory: subCat,
              tokens,
            });
          });

          // تحديث الأقسام الفرعية
          const existingCategories = JSON.parse(localStorage.getItem('categories')) || [];
          const existingSubCategories = JSON.parse(localStorage.getItem('subCategories')) || {};

          newPrompts.forEach(prompt => {
            const { category, subCategory } = prompt;

            // إضافة القسم الرئيسي إذا لم يكن موجودًا
            if (!existingCategories.includes(category)) {
              existingCategories.push(category);
            }

            // إضافة القسم الفرعي إذا كان موجودًا
            if (subCategory) {
              if (!existingSubCategories[category]) {
                existingSubCategories[category] = [];
              }
              if (!existingSubCategories[category].includes(subCategory)) {
                existingSubCategories[category].push(subCategory);
              }
            }
          });

          // دمج البرومبتات الجديدة مع القائمة الحالية
          const updatedPrompts = [...existingPrompts, ...newPrompts];
          localStorage.setItem('prompts', JSON.stringify(updatedPrompts));
          localStorage.setItem('categories', JSON.stringify(existingCategories));
          localStorage.setItem('subCategories', JSON.stringify(existingSubCategories));

          setMessage(`✅ تم استيراد ${newPrompts.length} برومبت جديد.`);
          fileInputRef.current.value = '';
        };

        reader.readAsText(file);
      };

      return (
        <div className="max-w-2xl mx-auto bg-white p-6 rounded shadow-md">
          <h1 className="text-2xl font-bold mb-6">استيراد البيانات</h1>
          <p className="mb-4 text-gray-700">
            ارفع ملف Markdown (.md) أو نصي (.txt) يحتوي على برومبتات جديدة. سيتم إضافتها إلى بياناتك الحالية.
          </p>

          <input
            ref={fileInputRef}
            type="file"
            accept=".md,.txt"
            onChange={handleFileUpload}
            className="mb-4"
          />

          {message && (
            <div className="mt-4 p-3 bg-green-100 text-green-800 rounded border border-green-300">
              {message}
            </div>
          )}

          <div className="mt-6 text-sm text-gray-500">
            <h3 className="font-semibold mb-2">مثال على تنسيق الملف:</h3>
            <pre className="bg-gray-100 p-3 rounded overflow-x-auto">
{`## تعليمي: رياضيات
1. **[تعليمي]:[رياضيات]** اشرح مفهوم التفاضل بطريقة بسيطة.
   - \`ID: 101\`
   - \`tokens: 23\`

## إبداعي: قصص
1. **[إبداعي]:[قصص]** اكتب قصة قصيرة عن رحلة إلى الفضاء.
   - \`ID: 102\`
   - \`tokens: 45\``}
            </pre>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
