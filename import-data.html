<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>استيراد البيانات - Promptica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"  crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"  crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> 

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"  rel="stylesheet">

  <!-- Internal Styles -->
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9fafb;
      color: #1f2937;
      line-height: 1.8;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    @media (max-width: 640px) {
      html { font-size: 16px; }
      textarea { font-size: 0.875rem; padding: 0.75rem; }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 p-4">

  <!-- Header -->
  <header class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6">
    <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700">Promptica</h1>
    <a href="index.html" class="text-indigo-600 hover:text-indigo-800 underline">العودة</a>
  </header>

  <!-- Root Div for React App -->
  <div id="root"></div>

  <!-- Footer -->
  <footer class="mt-8 pt-4 border-t border-gray-200 text-center text-sm text-gray-500">
    &copy; {new Date().getFullYear()} Promptica. جميع الحقوق محفوظة.
  </footer>

  <!-- React Code -->
  <script type="text/babel">
    const { useState } = window.React;

    function ImportDataPage() {
      const [inputText, setInputText] = useState('');
      const [parsedPrompts, setParsedPrompts] = useState([]);
      const [categories, setCategories] = useState(['عام']);
      const [subCategories, setSubCategories] = useState({});
      const [selectedMainCategory, setSelectedMainCategory] = useState('');
      const [selectedSubCategory, setSelectedSubCategory] = useState('');
      const [showResults, setShowResults] = useState(false);

      // تحميل البيانات من localStorage
      React.useEffect(() => {
        const savedCategories = JSON.parse(localStorage.getItem('categories'));
        const savedSubCategories = JSON.parse(localStorage.getItem('subCategories'));

        if (savedCategories) setCategories(savedCategories);
        if (savedSubCategories) setSubCategories(savedSubCategories);
      }, []);

      // دالة تحليل Markdown
      const parseMarkdown = (text) => {
        const lines = text.split('\n');
        const result = [];
        let currentMainCategory = '';
        let currentSubCategory = '';
        let promptBuffer = '';

        lines.forEach(line => {
          line = line.trim();
          if (line.startsWith('# ') && !line.startsWith('##')) {
            currentMainCategory = line.replace('# ', '').trim();
          } else if (line.startsWith('## ')) {
            currentSubCategory = line.replace('## ', '').trim();
          } else if (line.startsWith('>')) {
            promptBuffer = line.replace(/^>\s*/, '').trim();
            if (currentMainCategory && currentSubCategory && promptBuffer) {
              result.push({
                id: Date.now() + Math.random(),
                text: promptBuffer,
                category: currentMainCategory,
                subCategory: currentSubCategory,
                tokens: promptBuffer.split(/\s+/).length
              });
              promptBuffer = '';
            }
          }
        });

        return result;
      };

      // عند إدخال النص
      const handleInputChange = (e) => {
        const value = e.target.value;
        setInputText(value);
        const prompts = parseMarkdown(value);
        setParsedPrompts(prompts);
        setShowResults(!!value);
      };

      // حفظ البرومبتات
      const savePrompts = () => {
        if (!selectedMainCategory || !selectedSubCategory || parsedPrompts.length === 0) {
          alert("يرجى اختيار القسم الرئيسي والفرعي.");
          return;
        }

        const filteredPrompts = parsedPrompts.map(p => ({
          ...p,
          category: selectedMainCategory,
          subCategory: selectedSubCategory
        }));

        const existingPrompts = JSON.parse(localStorage.getItem('prompts')) || [];
        const updatedPrompts = [...existingPrompts, ...filteredPrompts];
        localStorage.setItem('prompts', JSON.stringify(updatedPrompts));
        setParsedPrompts([]);
        setInputText('');
        alert(`✅ تم حفظ ${filteredPrompts.length} برومبت.`);
      };

      return (
        <div className="container mx-auto max-w-4xl">
          <h2 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-6">استيراد البيانات</h2>

          {/* منطقة الإدخال */}
          <div className="bg-white p-6 rounded shadow-md mb-6">
            <label className="block text-lg font-medium mb-2">أدخل النص المراد استيراده:</label>
            <textarea
              rows="12"
              placeholder="لصق نص بصيغة Markdown يحتوي على أقسام وبرومبتات..."
              value={inputText}
              onChange={handleInputChange}
              className="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
            ></textarea>
          </div>

          {/* عرض النتائج التلقائية */}
          {showResults && parsedPrompts.length > 0 && (
            <div className="bg-white p-6 rounded shadow-md mb-6">
              <h3 className="font-semibold text-lg mb-4">البرومبتات المستخرجة:</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {parsedPrompts.slice(0, 5).map((prompt, idx) => (
                  <div key={idx} className="border border-gray-200 p-3 rounded hover:bg-gray-50">
                    <p className="text-sm text-gray-600">{prompt.text}</p>
                  </div>
                ))}
              </div>
              {parsedPrompts.length > 5 && (
                <p className="text-sm text-gray-500 mt-2">+ {parsedPrompts.length - 5} برومبت آخر...</p>
              )}
            </div>
          )}

          {/* اختيار القسم للحفظ */}
          {showResults && parsedPrompts.length > 0 && (
            <div className="bg-white p-6 rounded shadow-md mb-6">
              <h3 className="font-semibold text-lg mb-4">اختر القسم لإضافة البرومبتات:</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <select
                  value={selectedMainCategory}
                  onChange={(e) => setSelectedMainCategory(e.target.value)}
                  className="p-3 border border-gray-300 rounded"
                >
                  <option value="">اختر القسم الرئيسي</option>
                  {categories.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
                <select
                  value={selectedSubCategory}
                  onChange={(e) => setSelectedSubCategory(e.target.value)}
                  className="p-3 border border-gray-300 rounded"
                >
                  <option value="">اختر القسم الفرعي</option>
                  {subCategories[selectedMainCategory]?.map(sub => (
                    <option key={sub} value={sub}>{sub}</option>
                  ))}
                </select>
              </div>
              <button
                onClick={savePrompts}
                disabled={!selectedMainCategory || !selectedSubCategory}
                className={`mt-4 px-6 py-3 rounded transition-colors ${
                  selectedMainCategory && selectedSubCategory
                    ? 'bg-green-600 hover:bg-green-700 text-white'
                    : 'bg-gray-200 cursor-not-allowed text-gray-500'
                }`}
              >
                ✅ حفظ {parsedPrompts.length} برومبت
              </button>
            </div>
          )}

          {/* تعليمات التنسيق */}
          <div className="bg-blue-50 p-4 rounded shadow-md mb-6">
            <h3 className="font-semibold text-lg mb-2">كيفية التنسيق؟</h3>
            <pre className="bg-gray-100 p-3 rounded text-sm overflow-x-auto">
{`
# القسم الرئيسي
## القسم الفرعي
> هذا هو نص البرومبت الأول
> هذا هو نص البرومبت الثاني

# القسم الرئيسي 2
## القسم الفرعي 2
> نص برومبت جديد هنا
`.trim()}
            </pre>
          </div>
        </div>
      );
    }

    const root = window.ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ImportDataPage />);
  </script>
</body>
</html>
